stages:
  - build

variables:
  # This tells the Docker client to talk to the 'docker' service over the network
  DOCKER_HOST: tcp://docker:2376
  # This enables TLS (recommended for DinD) and matches the volume in your config.toml
  DOCKER_TLS_CERTDIR: "/certs"
  # Use overlay2 for better performance on Ubuntu
  DOCKER_DRIVER: overlay2

build-job:
  stage: build
  # This is the official Docker CLI image
  image: docker:27-cli 
  
  # This sidecar container runs the actual Docker Daemon
  services:
    - name: docker:27-dind
      alias: docker

  # Ensure this tag matches what you entered during 'gitlab-runner register'
  tags:
    - builds

  rules:
    - if: $CI_COMMIT_BRANCH == "main"

  before_script:
    # Diagnostic: Ensure the client can see the daemon before trying to log in
    - docker info
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY

  script:
    # Build with the commit SHA for versioning and 'latest' for the current release
    - docker build --pull -t "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA" -t "$CI_REGISTRY_IMAGE:latest" .
    
    # Push both tags to your GitLab Container Registry
    - docker push "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA"
    - docker push "$CI_REGISTRY_IMAGE:latest"